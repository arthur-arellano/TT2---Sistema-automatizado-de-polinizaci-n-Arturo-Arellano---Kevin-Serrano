# -*- coding: utf-8 -*-
"""sensores_analisis_datos.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/10_k1nbUVVfMIDV7ByN51x1MzeVs6t17M
"""

"""
ANÃLISIS DE ESTABILIDAD Y CORRELACIÃ“N DE TENDENCIAS
====================================================
ValidaciÃ³n de sensores Mi Flora para sistema de monitoreo distribuido

MÃ©tricas:
1. CV (Coeficiente de VariaciÃ³n): Estabilidad temporal por sensor
2. Spearman Ï: CorrelaciÃ³n de tendencias entre sensores
"""

import pandas as pd
import numpy as np
from scipy.stats import spearmanr
import warnings
warnings.filterwarnings('ignore')

from google.colab import files

print("\n" + "="*70)
print("  VALIDACIÃ“N DE SENSORES MI FLORA")
print("  AnÃ¡lisis de Estabilidad y CorrelaciÃ³n de Tendencias")
print("="*70 + "\n")

print("Sube los 4 archivos CSV de validaciÃ³n cruzada:\n")
uploaded = files.upload()

if not uploaded:
    print("No se cargaron archivos.")
    raise SystemExit

# =============================================================================
# CONFIGURACIÃ“N
# =============================================================================

NOMBRES_PARAMETROS = {
    'temperature': 'Temperatura (Â°C)',
    'moisture': 'Humedad (%)',
    'light': 'Luz (lux)',
    'conductivity': 'Conductividad (ÂµS/cm)'
}

SESIONES_INFO = {
    'miflora_log_validacion_cruzada_1': 'SesiÃ³n 1: MaÃ±ana - Sin malla',
    'miflora_log_validacion_cruzada_2': 'SesiÃ³n 2: Tarde - Sin malla',
    'miflora_log_validacion_cruzada_3': 'SesiÃ³n 3: MaÃ±ana - Malla 50%',
    'miflora_log_validacion_cruzada_4': 'SesiÃ³n 4: Tarde - Malla 50%'
}

# =============================================================================
# FUNCIONES DE ANÃLISIS
# =============================================================================

def calcular_cv(serie):
    """
    Calcula el Coeficiente de VariaciÃ³n (CV) de una serie.
    CV = (Ïƒ / Î¼) Ã— 100%
    """
    serie = serie.dropna()
    if len(serie) < 2:
        return np.nan
    media = serie.mean()
    if media == 0:
        return np.nan
    return (serie.std() / media) * 100


def calcular_spearman_promedio(df_pivot):
    """
    Calcula la correlaciÃ³n de Spearman promedio entre todos los pares de sensores.
    Ï = 1 - (6 Î£dÂ²) / (n(nÂ²-1))
    """
    sensores = df_pivot.columns.tolist()
    correlaciones = []

    for i in range(len(sensores)):
        for j in range(i+1, len(sensores)):
            s1, s2 = sensores[i], sensores[j]
            datos = df_pivot[[s1, s2]].dropna()

            if len(datos) < 5:
                continue

            if datos[s1].std() == 0 or datos[s2].std() == 0:
                continue

            rho, p_value = spearmanr(datos[s1], datos[s2])

            if not np.isnan(rho):
                correlaciones.append({
                    'par': f"{s1} â†” {s2}",
                    'rho': rho,
                    'p_value': p_value
                })

    return correlaciones


def analizar_sesion(df, nombre_sesion):
    """Analiza una sesiÃ³n: CV por sensor y Spearman entre pares."""

    print(f"\n{'='*70}")
    print(f" {nombre_sesion}")
    print(f"{'='*70}")

    df = df.copy().sort_values('timestamp').reset_index(drop=True)
    sensores = sorted(df['sensor_id'].unique().tolist())
    n_sensores = len(sensores)

    print(f"Registros: {len(df)} | Sensores: {n_sensores}")
    print(f"PerÃ­odo: {df['timestamp'].min().strftime('%Y-%m-%d %H:%M')} â†’ {df['timestamp'].max().strftime('%H:%M')}\n")

    df['ronda'] = df.index // n_sensores

    parametros = ['temperature', 'moisture', 'light', 'conductivity']
    resultados = {}

    for param in parametros:
        if df[param].isna().all():
            continue

        nombre = NOMBRES_PARAMETROS[param]
        print(f"{'â”€'*50}")
        print(f"ğŸ“Š {nombre}")
        print(f"{'â”€'*50}")

        # --- CV por sensor ---
        cvs = []
        print("\nâ–¸ Estabilidad (CV por sensor):")
        for sensor in sensores:
            datos = df[df['sensor_id'] == sensor][param]
            cv = calcular_cv(datos)
            media = datos.mean()
            std = datos.std()

            if not np.isnan(cv):
                cvs.append(cv)
                print(f"   {sensor}: CV = {cv:.2f}%  (Î¼ = {media:.2f} Â± {std:.2f})")

        cv_promedio = np.mean(cvs) if cvs else np.nan
        print(f"\n   â†’ CV promedio: {cv_promedio:.2f}%")

        # --- Spearman entre pares ---
        df_pivot = df.pivot_table(
            index='ronda',
            columns='sensor_id',
            values=param,
            aggfunc='mean'
        ).dropna()

        correlaciones = calcular_spearman_promedio(df_pivot)

        rho_promedio = np.nan
        if correlaciones:
            print("\nâ–¸ CorrelaciÃ³n de tendencias (Spearman Ï):")
            for c in correlaciones:
                sig = "***" if c['p_value'] < 0.001 else ("**" if c['p_value'] < 0.01 else ("*" if c['p_value'] < 0.05 else ""))
                print(f"   {c['par']}: Ï = {c['rho']:.3f}{sig}")

            rho_promedio = np.mean([c['rho'] for c in correlaciones])
            print(f"\n   â†’ Ï promedio: {rho_promedio:.3f}")
        else:
            print("\nâ–¸ Spearman: No calculable (datos constantes)")

        resultados[param] = {
            'cv_promedio': cv_promedio,
            'rho_promedio': rho_promedio,
            'n_muestras': len(df_pivot)
        }
        print()

    return resultados


# =============================================================================
# PROCESAR ARCHIVOS
# =============================================================================

todos_resultados = []
parametros = ['temperature', 'moisture', 'light', 'conductivity']

for fn in sorted(uploaded.keys()):
    try:
        df = pd.read_csv(fn, header=None)
        df.columns = ['timestamp', 'sensor_id', 'temperature', 'moisture',
                     'light', 'conductivity', 'battery']

        df['timestamp'] = pd.to_datetime(df['timestamp'], errors='coerce')
        for col in ['temperature', 'moisture', 'light', 'conductivity']:
            df[col] = pd.to_numeric(df[col], errors='coerce')

        df = df.dropna(subset=['timestamp', 'sensor_id'])
        df['sensor_id'] = df['sensor_id'].astype(str).str.strip()

        base_name = fn.replace('.csv', '').split('(')[0].strip()
        nombre_sesion = SESIONES_INFO.get(base_name, base_name)

        resultado = analizar_sesion(df, nombre_sesion)
        resultado['sesion'] = nombre_sesion
        todos_resultados.append(resultado)

    except Exception as e:
        print(f"âŒ Error en {fn}: {e}")


# =============================================================================
# RESULTADOS FINALES
# =============================================================================

print("\n" + "="*70)
print("RESULTADOS FINALES")
print("="*70)

resumen = []
for param in parametros:
    cvs = [r[param]['cv_promedio'] for r in todos_resultados if param in r and not np.isnan(r[param]['cv_promedio'])]
    rhos = [r[param]['rho_promedio'] for r in todos_resultados if param in r and not np.isnan(r[param]['rho_promedio'])]

    resumen.append({
        'ParÃ¡metro': NOMBRES_PARAMETROS[param],
        'CV (%)': np.mean(cvs) if cvs else np.nan,
        'Spearman Ï': np.mean(rhos) if rhos else np.nan
    })

df_resumen = pd.DataFrame(resumen)

print("\n" + "â”€"*70)
print("TABLA DE RESULTADOS")
print("â”€"*70)
print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ParÃ¡metro               â”‚ CV (%)   â”‚ Spearman Ï  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤""")

for _, row in df_resumen.iterrows():
    param = row['ParÃ¡metro']
    cv = row['CV (%)']
    rho = row['Spearman Ï']

    cv_str = f"{cv:.2f}" if not np.isnan(cv) else "--"
    rho_str = f"{rho:.2f}" if not np.isnan(rho) else "--"

    print(f"â”‚ {param:<23} â”‚ {cv_str:>8} â”‚ {rho_str:>11} â”‚")

print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

print("\n" + "="*70)
print("âœ… ANÃLISIS COMPLETADO")
print("="*70 + "\n")